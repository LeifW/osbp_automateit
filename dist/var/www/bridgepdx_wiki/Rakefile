# +---------------------------------------------------------------------+
# | WARNING: Do NOT edit this file directly or your changes will be     |
# | lost. If you need to change this file, you must incorporate your    |
# | changes into the AutomateIt project that created it. If you don't   |
# | know what this means, please talk to your system administrator.     |
# +---------------------------------------------------------------------+

# Tasks for manipulating the OpenSourceBridge MediaWiki instance

verbose(true) unless Rake.application.options.silent

task :default => :help

task :help do
  puts <<-HERE
OpenSourceBridge MediaWiki rake tasks:
- dump : Dump database to a FILE
- restore : Restore database from a FILE
- credentials : Display database credentials
  HERE
end

desc "Dump database to a FILE"
task :dump do
  sh "mysqldump --add-locks --create-options --disable-keys --extended-insert --quick --set-charset #{credentials_for_cli} > #{sql_filename}.tmp && mv #{sql_filename}.tmp #{sql_filename}"
end

desc "Restore database from a FILE"
task :restore do
  sh "mysql #{credentials_for_cli} < #{sql_filename}", :verbose => true
end

desc "Display database credentials"
task :credentials do
  p credentials_for_cli
end

def credentials_for_cli
   return "--user=#{credentials.user} --password=#{credentials.password} --host=#{credentials.host} #{credentials.database}"
end

def credentials
  return @@credentials ||= Credentials.import
end

def sql_filename
  return ENV['FILE'] || 'bridgepdx_wiki.sql'
end

# = Credentials
#
# Import the MediaWiki database configuration
class Credentials < Struct.new(:user, :password, :database, :host)
  def self.import(filename='LocalSettings.php')
    r = self.new
    open(filename) do |h|
      data = h.read
      r.user     = self.extract(data, 'DBuser')
      r.password = self.extract(data, 'DBpassword')
      r.database = self.extract(data, 'DBname')
      r.host     = self.extract(data, 'DBserver')
    end
    return r
  end

  def self.extract(data, key)
    return data[%r{^\$wg#{key}\s+=\s+"([^"]+)";}, 1]
  end
end
